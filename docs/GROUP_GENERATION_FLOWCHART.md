# 生成组节点流程图

## 整体流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    生成组节点流程 (generateGroupWithAI)          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 1: 初始化和验证                                             │
├─────────────────────────────────────────────────────────────────┤
│ 1.1 验证 API Key                                                │
│     ├─ 如果未设置 → 显示提示并返回                               │
│     └─ 如果已设置 → 继续                                         │
│                                                                 │
│ 1.2 获取活动 Canvas                                              │
│     ├─ 如果不存在 → 显示提示并返回                               │
│     └─ 如果存在 → 继续                                           │
│                                                                 │
│ 1.3 获取源节点                                                   │
│     ├─ 如果 sourceNode 参数存在 → 使用参数                       │
│     └─ 否则从 Canvas 选择中获取                                  │
│         ├─ 如果选择数量 ≠ 1 → 显示提示并返回                      │
│         └─ 如果选择数量 = 1 → 继续                                │
│                                                                 │
│ 1.4 保存待处理的更改                                             │
│     └─ canvas.requestSave() + sleep(200ms)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 2: 准备 AI 请求                                             │
├─────────────────────────────────────────────────────────────────┤
│ 2.1 构建消息上下文                                               │
│     └─ noteGenerator(app, settings, node)                        │
│                                                                 │
│ 2.2 准备用户提示词                                               │
│     ├─ 如果 userQuestion 存在 → 使用 userQuestion                │
│     └─ 否则使用默认提示词                                        │
│                                                                 │
│ 2.3 处理源节点为组的情况                                         │
│     ├─ 如果源节点是组 → 读取组内容并添加到提示词                 │
│     └─ 否则跳过                                                  │
│                                                                 │
│ 2.4 构建完整消息                                                 │
│     ├─ systemPrompt: SYSTEM_PROMPT_SMART_EXPAND_XML             │
│     ├─ prompt: finalPrompt                                      │
│     └─ buildMessages() → { messages, tokenCount }              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 3: 空间分析和位置计算                                        │
├─────────────────────────────────────────────────────────────────┤
│ 3.1 获取布局偏好设置                                             │
│     └─ getLayoutPreferences(settings)                           │
│                                                                 │
│ 3.2 分析最佳方向                                                 │
│     └─ analyzeBestDirection(canvas, node, preferences)          │
│         └─ 返回方向评分数组，选择最佳方向                        │
│                                                                 │
│ 3.3 计算组位置                                                   │
│     ├─ 设置初始尺寸: width=400, height=300                       │
│     ├─ 计算间距（如果有用户问题，增加 50px）                      │
│     └─ calculatePositionInDirection() → { x, y }                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 4: 创建组节点和主连线                                        │
├─────────────────────────────────────────────────────────────────┤
│ 4.1 创建组节点数据                                               │
│     ├─ 生成随机 ID (randomHexString)                             │
│     ├─ type: "group"                                            │
│     ├─ label: "New Group" (临时占位符)                           │
│     └─ 位置和尺寸: { x, y, width, height }                       │
│                                                                 │
│ 4.2 导入组节点到 Canvas                                          │
│     └─ canvas.importData({ nodes: [...existing, groupNode] })   │
│                                                                 │
│ 4.3 获取组节点引用                                                │
│     └─ canvas.nodes.get(groupId)                                 │
│                                                                 │
│ 4.4 计算连线方向                                                 │
│     ├─ 计算源节点和组节点的中心点                                 │
│     ├─ 计算 deltaX 和 deltaY                                    │
│     └─ 根据相对位置确定 fromSide 和 toSide                       │
│         ├─ 水平连接: right/left                                  │
│         └─ 垂直连接: bottom/top                                  │
│                                                                 │
│ 4.5 创建主连线                                                   │
│     ├─ 生成边 ID                                                │
│     ├─ 从源节点连接到组节点                                      │
│     └─ 标签: userQuestion (用户问题)                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 5: 初始化流式处理组件                                        │
├─────────────────────────────────────────────────────────────────┤
│ 5.1 创建增量 XML 解析器                                          │
│     └─ new IncrementalXMLParser()                                │
│                                                                 │
│ 5.2 创建增量 Markdown 解析器（备用）                             │
│     └─ new IncrementalMarkdownParser()                          │
│                                                                 │
│ 5.3 创建流式节点创建器                                           │
│     └─ new StreamingNodeCreator(canvas, node, settings)         │
│                                                                 │
│ 5.4 设置预创建组信息                                             │
│     └─ nodeCreator.setPreCreatedGroup(                          │
│           groupNode, "g1", mainEdgeId, userQuestion)            │
│                                                                 │
│ 5.5 初始化流式处理变量                                           │
│     ├─ accumulatedResponse = ""                                 │
│     └─ lastNodeUpdate = Date.now()                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 6: 流式接收和处理 AI 响应                                    │
├─────────────────────────────────────────────────────────────────┤
│ 6.1 调用流式 API                                                 │
│     └─ streamResponse(apiKey, messages, options, callback)       │
│                                                                 │
│ 6.2 对每个数据块 (chunk) 进行处理                                │
│     │                                                           │
│     ├─ 6.2.1 错误处理                                           │
│     │   └─ 如果 error → 抛出错误                                 │
│     │                                                           │
│     ├─ 6.2.2 流结束处理                                         │
│     │   └─ 如果 chunk === null → 记录完整响应并返回              │
│     │                                                           │
│     └─ 6.2.3 增量解析和创建（chunk 不为空）                      │
│         │                                                       │
│         ├─ 追加到累积响应                                        │
│         │   └─ accumulatedResponse += chunk                     │
│         │                                                       │
│         ├─ XML 解析器处理                                        │
│         │   ├─ xmlParser.append(chunk)                          │
│         │   │                                                   │
│         │   ├─ 检测完整边（优先处理）                            │
│         │   │   └─ detectCompleteEdges()                        │
│         │   │       └─ 存储边到 nodeCreator                      │
│         │   │                                                   │
│         │   ├─ 检测完整节点                                      │
│         │   │   └─ detectCompleteNodes()                        │
│         │   │       └─ 为每个节点调用 createNodeFromXML()       │
│         │   │                                                   │
│         │   ├─ 实时更新（节流 50ms）                             │
│         │   │   ├─ 更新部分组: updatePartialGroup()             │
│         │   │   └─ 更新部分节点: updatePartialNode()            │
│         │   │                                                   │
│         │   └─ 检测完整组                                        │
│         │       └─ detectCompleteGroups()                        │
│         │           └─ 为每个组调用 createGroupFromXML()         │
│         │                                                   │
│         └─ Markdown 解析器处理（备用，如果 XML 解析器不存在）     │
│             ├─ mdParser.append(chunk)                            │
│             └─ detectCompleteNodes()                            │
│                 └─ 为每个节点调用 createNodeFromParsed()         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 阶段 7: 完成处理                                                 │
├─────────────────────────────────────────────────────────────────┤
│ 7.1 处理剩余内容                                                 │
│     ├─ 最终更新所有不完整的组和节点                              │
│     ├─ 处理剩余的边                                              │
│     ├─ 处理剩余的节点                                            │
│     └─ 创建所有待处理的节点（无连接的节点）                       │
│                                                                 │
│ 7.2 创建所有剩余的边                                             │
│     └─ nodeCreator.createAllEdges()                             │
│                                                                 │
│ 7.3 更新组边界                                                   │
│     ├─ 获取组内所有节点                                          │
│     ├─ 计算最小/最大坐标                                         │
│     └─ 更新组节点的位置和尺寸（包含 padding）                     │
│                                                                 │
│ 7.4 显示成功通知                                                 │
│     └─ Notice("✓ Created N nodes and M connections...")         │
│                                                                 │
│ 7.5 保存 Canvas                                                  │
│     └─ canvas.requestSave()                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 详细子流程

### 子流程 A: 增量 XML 解析

```
┌─────────────────────────────────────────────────────────────┐
│           增量 XML 解析流程 (IncrementalXMLParser)            │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ append(chunk)         │
        │ buffer += chunk       │
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ 完整元素检测   │      │ 不完整元素检测 │
└───────────────┘      └───────────────┘
        │                       │
        ├─ detectCompleteNodes()│
        ├─ detectCompleteEdges()│
        ├─ detectCompleteGroups()│
        │                       │
        │                       ├─ detectIncompleteNodes()
        │                       └─ detectIncompleteGroups()
        │
        ▼
┌───────────────────────┐
│ 解析 XML 元素          │
│ - 提取属性 (id, type)  │
│ - 提取内容 (Markdown)  │
│ - 检测组关系           │
└───────────────────────┘
        │
        ▼
┌───────────────────────┐
│ 返回解析结果           │
│ - NodeXML[]           │
│ - EdgeXML[]           │
│ - GroupXML[]          │
└───────────────────────┘
```

### 子流程 B: 流式节点创建

```
┌─────────────────────────────────────────────────────────────┐
│        流式节点创建流程 (StreamingNodeCreator)                │
└─────────────────────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ 创建完整节点   │      │ 更新部分节点   │
│ createNodeFrom│      │ updatePartial │
│ XML()         │      │ Node()        │
└───────────────┘      └───────────────┘
        │                       │
        ├─ 解析坐标              │
        ├─ 计算像素位置          │
        ├─ 应用类型颜色          │
        ├─ 检查依赖关系          │
        ├─ 创建 Canvas 节点      │
        └─ 存储到 createdNodeMap │
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ 存储边信息     │      │ 创建组        │
│ storeEdge()   │      │ createGroup   │
│               │      │ FromXML()     │
└───────────────┘      └───────────────┘
        │                       │
        │                       ├─ 匹配预创建组
        │                       ├─ 更新组标题
        │                       └─ 添加节点到组
        │
        ▼
┌───────────────────────┐
│ 创建边连接             │
│ createAllEdges()      │
│ - 检查节点是否存在     │
│ - 计算连接方向         │
│ - 创建 Canvas 边       │
└───────────────────────┘
```

### 子流程 C: 空间分析

```
┌─────────────────────────────────────────────────────────────┐
│              空间分析流程 (spatialAnalyzer)                   │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ analyzeBestDirection()│
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐      ┌───────────────┐
│ 分析四个方向   │      │ 检查碰撞       │
│ - Right       │      │ - 现有节点     │
│ - Bottom      │      │ - Canvas 边界  │
│ - Left        │      │ - 其他组       │
│ - Top         │      │                │
└───────────────┘      └───────────────┘
        │                       │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ 计算方向评分           │
        │ - 可用空间大小         │
        │ - 碰撞惩罚             │
        │ - 偏好权重             │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ 返回排序后的方向数组   │
        │ [最佳, 次佳, ...]      │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ calculatePositionIn   │
        │ Direction()            │
        │ - 基于源节点位置       │
        │ - 应用间距             │
        │ - 返回 { x, y }        │
        └───────────────────────┘
```

## 关键数据结构

### NodeXML
```typescript
{
  id: string;           // 节点 ID
  type?: NodeType;      // 节点类型 (concept, step, etc.)
  title?: string;       // 节点标题
  row?: number;         // 相对行坐标
  col?: number;         // 相对列坐标
  groupId?: string;     // 所属组 ID
  content: string;      // Markdown 内容
}
```

### EdgeXML
```typescript
{
  from: string;         // 源节点 ID
  to: string;           // 目标节点 ID
  dir?: string;         // 方向 (forward, backward)
  label?: string;       // 边标签
}
```

### GroupXML
```typescript
{
  id: string;           // 组 ID
  title?: string;       // 组标题
  row?: number;         // 相对行坐标
  col?: number;         // 相对列坐标
  nodes: NodeXML[];     // 组内节点
  edges: EdgeXML[];     // 组内边
}
```

## 关键特性

### 1. 流式处理
- **实时更新**: 节点在 AI 响应过程中逐步创建和更新
- **增量解析**: XML 解析器检测完整的元素，即使响应还在流式传输
- **节流更新**: 部分节点更新限制为每 50ms 一次，避免性能问题

### 2. 连线优先策略
- **边优先存储**: 在创建节点之前先检测和存储边信息
- **依赖感知**: 节点创建时知道哪些节点会连接到它
- **延迟创建**: 有依赖的节点等待依赖节点创建后再创建

### 3. 预创建组
- **立即创建**: 在 AI 响应开始前就创建组节点
- **语义匹配**: 通过语义 ID ("g1") 匹配 AI 生成的组
- **实时更新**: 组标题和内容在流式过程中实时更新

### 4. 智能布局
- **空间分析**: 分析 Canvas 上现有节点，选择最佳位置
- **方向评分**: 评估四个方向的可用空间和碰撞情况
- **坐标转换**: 将相对坐标 (row, col) 转换为绝对像素坐标

### 5. 错误处理
- **验证检查**: 每个阶段都有验证，失败时显示友好提示
- **降级处理**: XML 解析失败时可以使用 Markdown 解析器
- **未解析内容**: 检测并警告未解析的 XML 内容

## 性能优化

1. **节流更新**: 部分节点更新限制为 50ms 间隔
2. **批量操作**: 使用 `canvas.requestFrame()` 批量更新渲染
3. **延迟创建**: 有依赖的节点延迟创建，避免重复计算
4. **缓存位置**: 已创建节点的位置被缓存，用于后续计算

## 注意事项

1. **XML 格式要求**: AI 必须输出有效的 XML 格式，包含 `<group>` 包裹所有节点
2. **坐标系统**: 使用相对坐标系统 (row, col)，然后转换为像素坐标
3. **组边界更新**: 组边界在最后阶段更新，确保包含所有节点
4. **边创建时机**: 边在节点创建后创建，但边信息在节点创建前就已知

