# 智能布局系统测试指南

**Date**: January 5, 2026  
**Feature**: Smart Layout System with Spatial Analysis  
**Status**: ✅ **IMPLEMENTED & READY FOR TESTING**

---

## 测试概述

本文档提供了智能布局系统的完整测试指南，包括各种场景的测试方法和预期结果。

---

## 前置条件

1. **构建项目**：
   ```bash
   npm run build
   ```

2. **在 Obsidian 中启用插件**：
   - 打开 Obsidian 设置
   - 进入 Community plugins
   - 启用 "Augmented Canvas" 插件

3. **配置 API Key**：
   - 在插件设置中输入 DeepSeek API Key
   - 测试 API 连接

4. **配置布局偏好**（可选）：
   - 在"智能布局设置"部分
   - 选择布局模式（建议先用"智能自适应"）
   - 调整最小间距和避免重叠强度

---

## 测试场景

### 场景 1：空旷画布 - Ask AI 单节点生成 ✅

**目的**：测试在空旷画布上，AI 生成的节点是否智能选择方向

**步骤**：
1. 创建一个新的 Canvas
2. 添加一个文本节点，内容："什么是人工智能？"
3. 选中该节点
4. 点击 "Ask AI" 按钮
5. 等待 AI 生成回答

**预期结果**：
- ✅ 新节点应该出现在源节点的**右侧**（默认方向优先级）
- ✅ 节点之间有合适的间距（默认 60px）
- ✅ 不会固定在底部

**验证方法**：
- 检查新节点的位置
- 测量节点间距是否合理
- 在控制台查看日志：`[SmartLayout] Best direction: right`

---

### 场景 2：右侧拥挤 - 自动选择其他方向 ✅

**目的**：测试当右侧已有节点时，系统是否智能选择其他方向

**步骤**：
1. 在画布上创建一个中心节点 A
2. 在 A 的右侧手动添加 2-3 个节点
3. 选中节点 A
4. 使用 "Ask AI" 提问
5. 观察新节点的位置

**预期结果**：
- ✅ 新节点应该避开右侧拥挤区域
- ✅ 可能出现在**下方**或**左侧**
- ✅ 空间评分会显示右侧分数较低

**验证方法**：
- 查看控制台日志中的方向分数
- 确认新节点不在右侧拥挤区域
- 检查是否有碰撞或重叠

---

### 场景 3：环绕布局 - 多方向分布 ✅

**目的**：测试当中心节点四周都有空间时，系统的选择策略

**步骤**：
1. 创建中心节点
2. 在右侧和下方各放置一个节点（留出左侧和上方空间）
3. 多次使用 "Ask AI" 生成新节点
4. 观察节点的分布模式

**预期结果**：
- ✅ 节点应该优先填充空旷区域（左侧、上方）
- ✅ 不会全部堆积在一个方向
- ✅ 形成较为均衡的分布

**验证方法**：
- 观察节点是否分散在各个方向
- 检查空间利用率
- 确认没有不必要的重叠

---

### 场景 4：Generate Group - 线性流程 ✅

**目的**：测试 Generate Group 功能生成线性流程的效果

**步骤**：
1. 创建一个节点："如何制作咖啡"
2. 选中节点
3. 点击 "Generate Group with AI"
4. 输入提示：Generate step-by-step instructions
5. 等待 AI 生成多个步骤节点

**预期结果**：
- ✅ AI 应该使用语义定位（步骤1 → 步骤2 → 步骤3）
- ✅ 节点可能横向排列（右侧展开）或纵向排列（下方展开）
- ✅ 空间分析会优化位置避免重叠
- ✅ 实时显示边缘连接

**验证方法**：
- 检查节点是否按逻辑顺序排列
- 观察边缘是否正确连接
- 查看日志中的 AI 坐标建议和空间分析结果

---

### 场景 5：Generate Group - 分支结构 ✅

**目的**：测试生成分支状结构的智能布局

**步骤**：
1. 创建节点："编程语言的分类"
2. 使用 "Generate Group with AI"
3. 输入：Generate different categories with examples
4. 等待 AI 生成分类节点

**预期结果**：
- ✅ AI 应该生成多个并列的概念节点
- ✅ 节点分布应该呈辐射状或并列状
- ✅ 使用不同的 row/col 组合避免重叠
- ✅ 边缘关系清晰（可能有 A→B, A→C, A→D）

**验证方法**：
- 检查节点是否均匀分布在源节点周围
- 观察是否有清晰的层次结构
- 确认边缘连接反映了语义关系

---

### 场景 6：拥挤画布中生成 - 碰撞避免 ✅

**目的**：测试在已有大量节点的画布上，新节点如何智能避让

**步骤**：
1. 创建一个有 10+ 个节点的复杂画布
2. 选择中间的一个节点
3. 使用 "Ask AI" 生成新节点
4. 重复多次

**预期结果**：
- ✅ 新节点应该自动寻找空白区域
- ✅ 避免与现有节点重叠
- ✅ 当所有方向都拥挤时，使用垂直偏移

**验证方法**：
- 检查是否有节点重叠
- 观察空间利用的合理性
- 查看 `isPositionOccupied()` 的碰撞检测结果

---

### 场景 7：不同布局模式测试 ✅

**目的**：测试不同布局模式的效果差异

**步骤**：

#### 7.1 智能模式（默认）
1. 设置布局模式为"智能自适应"
2. 进行场景 1-6 的测试
3. 观察系统如何根据空间情况自动选择

#### 7.2 横向模式
1. 设置布局模式为"横向布局"
2. 生成多个节点
3. 预期：节点倾向于横向排列

#### 7.3 纵向模式
1. 设置布局模式为"纵向布局"
2. 生成多个节点
3. 预期：节点倾向于纵向排列（下方堆叠）

#### 7.4 辐射状模式
1. 设置布局模式为"辐射状布局"
2. 生成多个节点
3. 预期：节点围绕中心节点分布

**验证方法**：
- 对比不同模式下的节点分布特征
- 确认模式设置生效
- 检查是否符合预期的布局风格

---

### 场景 8：方向优先级测试 ✅

**目的**：测试方向优先级配置的影响

**步骤**：
1. 默认优先级：右 → 下 → 左 → 上
2. 在空旷画布上生成节点（应该优先向右）
3. 修改优先级为：下 → 右 → 左 → 上
4. 在相同场景下再次测试
5. 观察节点位置的变化

**预期结果**：
- ✅ 优先级设置影响初始方向选择
- ✅ 在同等分数下，优先级高的方向被选中
- ✅ 设置更改后立即生效

**验证方法**：
- 对比优先级更改前后的节点位置
- 查看控制台中的 `preferenceScore` 值
- 验证方向旋转按钮功能

---

### 场景 9：间距和重叠强度测试 ✅

**目的**：测试间距和避免重叠强度的影响

**步骤**：

#### 9.1 最小间距测试
1. 设置最小间距为 30px（较小）
2. 生成多个节点
3. 观察节点紧密程度
4. 设置最小间距为 100px（较大）
5. 再次生成节点
6. 对比间距差异

#### 9.2 避免重叠强度测试
1. 设置避免重叠强度为 0（不避免）
2. 在拥挤区域生成节点
3. 设置避免重叠强度为 100（最强）
4. 观察差异

**预期结果**：
- ✅ 间距设置直接影响节点距离
- ✅ 避免重叠强度影响碰撞检测的敏感度
- ✅ 设置在合理范围内都能正常工作

---

### 场景 10：AI 坐标尊重度测试 ✅

**目的**：测试"尊重 AI 坐标建议"开关的效果

**步骤**：
1. 启用"尊重 AI 坐标建议"
2. 使用 Generate Group 生成多节点
3. 观察是否使用了 AI 建议的 row/col 位置
4. 禁用"尊重 AI 坐标建议"
5. 再次生成
6. 观察是否更多使用空间分析结果

**预期结果**：
- ✅ 启用时：优先使用 AI 的坐标建议
- ✅ 禁用时：完全依赖空间分析
- ✅ 两种模式都能避免碰撞

**验证方法**：
- 查看日志中的决策过程
- 对比节点最终位置与 AI 建议的差异
- 检查 `mergeAISuggestionWithSpatialAnalysis` 函数的日志

---

## 性能测试

### 测试 1：生成速度 ⚡
**步骤**：
1. 测量生成单个节点的时间
2. 测量生成 Group（5-10 个节点）的时间
3. 记录空间分析的计算开销

**预期结果**：
- ✅ 单节点增加 <5ms 延迟
- ✅ 多节点生成时流畅显示
- ✅ 不影响用户体验

### 测试 2：大量节点场景 📊
**步骤**：
1. 创建包含 50+ 个节点的画布
2. 在中心生成新节点
3. 测量空间分析时间

**预期结果**：
- ✅ 即使有大量节点，分析时间仍可接受
- ✅ 不会导致明显的卡顿

---

## 回归测试

### 测试 1：向后兼容性 🔄
**步骤**：
1. 测试现有功能是否正常工作
2. 验证不启用智能布局时的行为
3. 确认旧的 canvas 文件能正常加载

**预期结果**：
- ✅ 所有现有功能正常
- ✅ 不传递 settings 参数时使用旧逻辑
- ✅ 旧的 canvas 文件兼容

### 测试 2：设置持久化 💾
**步骤**：
1. 修改布局偏好设置
2. 重启 Obsidian
3. 验证设置是否保存

**预期结果**：
- ✅ 设置正确保存到 data.json
- ✅ 重启后设置保持不变

---

## 调试和日志

### 控制台日志

在浏览器控制台（Ctrl+Shift+I）中查看以下日志：

```
[SmartLayout] Best direction: right (score: 85.23)
[StreamingNodeCreator] AI suggested: (500, 300)
[StreamingNodeCreator] Spatial analysis best: down (score: 72.15)
[StreamingNodeCreator] Using spatial analysis: down
```

### 关键日志点

1. **createNode 函数**：
   - 显示选择的最佳方向和分数
   - 标识是否使用智能定位

2. **StreamingNodeCreator**：
   - AI 建议的位置
   - 空间分析的结果
   - 最终决策（AI vs 空间分析）

3. **空间分析器**：
   - 各方向的评分细节
   - 碰撞检测结果
   - 密度计算

---

## 常见问题排查

### 问题 1：节点仍然固定在底部
**原因**：Settings 未传递给 createNode
**解决**：检查 noteGenerator.ts 是否传递了 settings 参数

### 问题 2：节点重叠
**原因**：碰撞检测未生效或间距设置过小
**解决**：
- 增加最小间距
- 提高避免重叠强度
- 检查 `isPositionOccupied` 函数

### 问题 3：布局不够智能
**原因**：空间评分算法需要调优
**解决**：
- 调整权重（距离、密度、偏好、边界）
- 修改 `scoreDirection` 函数的计算逻辑
- 增加更多因素考虑

### 问题 4：Generate Group 忽略 AI 建议
**原因**："尊重 AI 坐标建议"被禁用
**解决**：在设置中启用该选项

---

## 测试检查清单

- [ ] **场景 1**：空旷画布测试通过
- [ ] **场景 2**：右侧拥挤测试通过
- [ ] **场景 3**：环绕布局测试通过
- [ ] **场景 4**：线性流程测试通过
- [ ] **场景 5**：分支结构测试通过
- [ ] **场景 6**：拥挤画布测试通过
- [ ] **场景 7**：所有布局模式测试通过
- [ ] **场景 8**：方向优先级测试通过
- [ ] **场景 9**：间距和强度测试通过
- [ ] **场景 10**：AI 尊重度测试通过
- [ ] **性能测试**：无明显延迟
- [ ] **回归测试**：向后兼容
- [ ] **设置 UI**：所有设置项可用且有效
- [ ] **构建测试**：npm run build 成功
- [ ] **无 Linter 错误**

---

## 下一步优化方向

### 短期（可选）

1. **视觉反馈**：
   - 在生成节点时显示方向选择的可视化
   - 高亮显示选中的方向和分数

2. **更多布局策略**：
   - 实现 `layoutStrategies.ts` 中的不同布局类
   - 支持用户自定义布局算法

3. **智能连线优化**：
   - 根据节点位置智能选择连线端点
   - 避免连线交叉

### 中期（未来版本）

1. **机器学习**：
   - 学习用户的布局偏好
   - 根据内容类型自动选择布局模式

2. **力导向图**：
   - 实现物理模拟布局
   - 自动优化节点位置减少边缘交叉

3. **高级设置**：
   - 自定义评分权重
   - 导入/导出布局配置

---

## 测试报告模板

```markdown
## 测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: [姓名]
**插件版本**: 0.1.16

### 测试结果汇总
- 通过场景: X/10
- 失败场景: Y/10
- 性能评分: [优秀/良好/需改进]

### 详细结果
[场景编号] - [通过/失败] - [备注]

### 发现的问题
1. [问题描述]
2. [问题描述]

### 建议
1. [改进建议]
2. [改进建议]
```

---

**测试完成后，请标记 TODO 为已完成！** ✅

